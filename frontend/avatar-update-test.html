<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>头像更新测试</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        .avatar-display {
            display: flex;
            gap: 20px;
            align-items: center;
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }
        .avatar-item {
            text-align: center;
        }
        .avatar-item img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #e0e0e0;
        }
        .avatar-item h4 {
            margin: 10px 0 5px;
            font-size: 14px;
            color: #333;
        }
        .test-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .test-button:hover {
            background: #5a6fd8;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 6px;
            font-size: 14px;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.info { background: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>🧪 头像更新测试</h1>
        <p>测试个人资料更新后，页面上的头像是否同步更新</p>

        <div class="avatar-display">
            <div class="avatar-item">
                <img id="navAvatar" src="https://via.placeholder.com/60" alt="导航栏头像">
                <h4>导航栏小头像</h4>
            </div>
            <div class="avatar-item">
                <img id="dropdownAvatar" src="https://via.placeholder.com/60" alt="下拉菜单头像">
                <h4>下拉菜单大头像</h4>
            </div>
            <div class="avatar-item">
                <img id="profileAvatar" src="https://via.placeholder.com/60" alt="个人资料头像">
                <h4>个人资料头像</h4>
            </div>
        </div>

        <div>
            <button class="test-button" onclick="loadCurrentAvatars()">加载当前头像</button>
            <button class="test-button" onclick="simulateAvatarUpdate()">模拟头像更新</button>
            <button class="test-button" onclick="checkUserInfo()">检查用户信息</button>
            <button class="test-button" onclick="refreshUserInfo()">刷新用户信息</button>
        </div>

        <div id="testResults"></div>

        <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
            <h3>🎯 测试步骤</h3>
            <ol>
                <li>确保已登录用户账户</li>
                <li>点击"加载当前头像"查看当前状态</li>
                <li>打开个人资料模态框，上传新头像</li>
                <li>保存后检查页面上的头像是否同步更新</li>
                <li>刷新页面验证头像是否持久化</li>
            </ol>
            
            <h3>✅ 预期结果</h3>
            <ul>
                <li>上传头像后，所有位置的头像都应该立即更新</li>
                <li>刷新页面后，新头像应该保持显示</li>
                <li>头像URL应该指向Supabase存储的文件</li>
            </ul>
        </div>
    </div>

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabaseClient.js"></script>

    <script>
        function showResult(message, type = 'info') {
            const resultsDiv = document.getElementById('testResults');
            const statusDiv = document.createElement('div');
            statusDiv.className = `status ${type}`;
            statusDiv.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
            resultsDiv.appendChild(statusDiv);
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        async function loadCurrentAvatars() {
            try {
                // 获取页面上的头像元素
                const navAvatarImg = document.getElementById('userAvatarImg');
                const dropdownAvatarImg = document.getElementById('userAvatarImgLarge');
                const profileAvatarImg = document.getElementById('profileAvatarImg');

                // 更新测试显示
                if (navAvatarImg) {
                    document.getElementById('navAvatar').src = navAvatarImg.src;
                    showResult(`导航栏头像: ${navAvatarImg.src}`, 'info');
                }

                if (dropdownAvatarImg) {
                    document.getElementById('dropdownAvatar').src = dropdownAvatarImg.src;
                    showResult(`下拉菜单头像: ${dropdownAvatarImg.src}`, 'info');
                }

                if (profileAvatarImg) {
                    document.getElementById('profileAvatar').src = profileAvatarImg.src;
                    showResult(`个人资料头像: ${profileAvatarImg.src}`, 'info');
                }

                showResult('✅ 当前头像加载完成', 'success');
            } catch (error) {
                showResult(`❌ 加载头像失败: ${error.message}`, 'error');
            }
        }

        async function simulateAvatarUpdate() {
            try {
                // 模拟头像更新
                const testAvatarUrl = `https://ui-avatars.com/api/?name=Test&background=ff6b6b&color=fff&size=120&t=${Date.now()}`;
                
                if (window.userDropdownManager) {
                    const currentInfo = await window.userDropdownManager.getCurrentUserInfo();
                    if (currentInfo) {
                        const updatedInfo = {
                            ...currentInfo,
                            avatar: testAvatarUrl
                        };
                        window.userDropdownManager.updateUserInfo(updatedInfo);
                        showResult('✅ 模拟头像更新完成', 'success');
                        
                        // 重新加载显示
                        setTimeout(() => loadCurrentAvatars(), 500);
                    }
                } else {
                    showResult('❌ userDropdownManager 未找到', 'error');
                }
            } catch (error) {
                showResult(`❌ 模拟更新失败: ${error.message}`, 'error');
            }
        }

        async function checkUserInfo() {
            try {
                if (!window.supabaseClient) {
                    throw new Error('Supabase客户端未初始化');
                }

                // 检查认证状态
                const { data: { user }, error } = await window.supabaseClient.auth.getUser();
                if (error) throw error;

                if (user) {
                    showResult(`✅ 用户已登录: ${user.email}`, 'success');
                    
                    // 检查profiles表数据
                    const { data: profiles, error: profileError } = await window.supabaseClient
                        .from('profiles')
                        .select('username, avatar_url')
                        .eq('id', user.id)
                        .single();

                    if (profileError) {
                        showResult(`⚠️ 获取profile失败: ${profileError.message}`, 'error');
                    } else {
                        showResult(`📋 Profile数据: username=${profiles.username || '未设置'}, avatar_url=${profiles.avatar_url || '未设置'}`, 'info');
                    }

                    // 检查userDropdownManager状态
                    if (window.userDropdownManager) {
                        const userInfo = await window.userDropdownManager.getCurrentUserInfo();
                        showResult(`👤 当前用户信息: ${JSON.stringify(userInfo)}`, 'info');
                    }
                } else {
                    showResult('❌ 用户未登录', 'error');
                }
            } catch (error) {
                showResult(`❌ 检查用户信息失败: ${error.message}`, 'error');
            }
        }

        async function refreshUserInfo() {
            try {
                if (window.userDropdownManager) {
                    const userInfo = await window.userDropdownManager.getCurrentUserInfo();
                    if (userInfo) {
                        window.userDropdownManager.updateUserInfo(userInfo);
                        showResult('✅ 用户信息刷新完成', 'success');
                        
                        // 重新加载显示
                        setTimeout(() => loadCurrentAvatars(), 500);
                    }
                } else {
                    showResult('❌ userDropdownManager 未找到', 'error');
                }
            } catch (error) {
                showResult(`❌ 刷新失败: ${error.message}`, 'error');
            }
        }

        // 页面加载完成后的初始化
        document.addEventListener('DOMContentLoaded', () => {
            showResult('🚀 头像更新测试页面加载完成', 'info');
            
            // 延迟加载，确保其他脚本已初始化
            setTimeout(() => {
                loadCurrentAvatars();
                checkUserInfo();
            }, 1000);
        });
    </script>
</body>
</html>
