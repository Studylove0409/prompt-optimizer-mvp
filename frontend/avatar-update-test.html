<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤´åƒæ›´æ–°æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        .avatar-display {
            display: flex;
            gap: 20px;
            align-items: center;
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }
        .avatar-item {
            text-align: center;
        }
        .avatar-item img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #e0e0e0;
        }
        .avatar-item h4 {
            margin: 10px 0 5px;
            font-size: 14px;
            color: #333;
        }
        .test-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .test-button:hover {
            background: #5a6fd8;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 6px;
            font-size: 14px;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.info { background: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ§ª å¤´åƒæ›´æ–°æµ‹è¯•</h1>
        <p>æµ‹è¯•ä¸ªäººèµ„æ–™æ›´æ–°åï¼Œé¡µé¢ä¸Šçš„å¤´åƒæ˜¯å¦åŒæ­¥æ›´æ–°</p>

        <div class="avatar-display">
            <div class="avatar-item">
                <img id="navAvatar" src="https://via.placeholder.com/60" alt="å¯¼èˆªæ å¤´åƒ">
                <h4>å¯¼èˆªæ å°å¤´åƒ</h4>
            </div>
            <div class="avatar-item">
                <img id="dropdownAvatar" src="https://via.placeholder.com/60" alt="ä¸‹æ‹‰èœå•å¤´åƒ">
                <h4>ä¸‹æ‹‰èœå•å¤§å¤´åƒ</h4>
            </div>
            <div class="avatar-item">
                <img id="profileAvatar" src="https://via.placeholder.com/60" alt="ä¸ªäººèµ„æ–™å¤´åƒ">
                <h4>ä¸ªäººèµ„æ–™å¤´åƒ</h4>
            </div>
        </div>

        <div>
            <button class="test-button" onclick="loadCurrentAvatars()">åŠ è½½å½“å‰å¤´åƒ</button>
            <button class="test-button" onclick="simulateAvatarUpdate()">æ¨¡æ‹Ÿå¤´åƒæ›´æ–°</button>
            <button class="test-button" onclick="checkUserInfo()">æ£€æŸ¥ç”¨æˆ·ä¿¡æ¯</button>
            <button class="test-button" onclick="refreshUserInfo()">åˆ·æ–°ç”¨æˆ·ä¿¡æ¯</button>
        </div>

        <div id="testResults"></div>

        <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
            <h3>ğŸ¯ æµ‹è¯•æ­¥éª¤</h3>
            <ol>
                <li>ç¡®ä¿å·²ç™»å½•ç”¨æˆ·è´¦æˆ·</li>
                <li>ç‚¹å‡»"åŠ è½½å½“å‰å¤´åƒ"æŸ¥çœ‹å½“å‰çŠ¶æ€</li>
                <li>æ‰“å¼€ä¸ªäººèµ„æ–™æ¨¡æ€æ¡†ï¼Œä¸Šä¼ æ–°å¤´åƒ</li>
                <li>ä¿å­˜åæ£€æŸ¥é¡µé¢ä¸Šçš„å¤´åƒæ˜¯å¦åŒæ­¥æ›´æ–°</li>
                <li>åˆ·æ–°é¡µé¢éªŒè¯å¤´åƒæ˜¯å¦æŒä¹…åŒ–</li>
            </ol>
            
            <h3>âœ… é¢„æœŸç»“æœ</h3>
            <ul>
                <li>ä¸Šä¼ å¤´åƒåï¼Œæ‰€æœ‰ä½ç½®çš„å¤´åƒéƒ½åº”è¯¥ç«‹å³æ›´æ–°</li>
                <li>åˆ·æ–°é¡µé¢åï¼Œæ–°å¤´åƒåº”è¯¥ä¿æŒæ˜¾ç¤º</li>
                <li>å¤´åƒURLåº”è¯¥æŒ‡å‘Supabaseå­˜å‚¨çš„æ–‡ä»¶</li>
            </ul>
        </div>
    </div>

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabaseClient.js"></script>

    <script>
        function showResult(message, type = 'info') {
            const resultsDiv = document.getElementById('testResults');
            const statusDiv = document.createElement('div');
            statusDiv.className = `status ${type}`;
            statusDiv.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
            resultsDiv.appendChild(statusDiv);
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        async function loadCurrentAvatars() {
            try {
                // è·å–é¡µé¢ä¸Šçš„å¤´åƒå…ƒç´ 
                const navAvatarImg = document.getElementById('userAvatarImg');
                const dropdownAvatarImg = document.getElementById('userAvatarImgLarge');
                const profileAvatarImg = document.getElementById('profileAvatarImg');

                // æ›´æ–°æµ‹è¯•æ˜¾ç¤º
                if (navAvatarImg) {
                    document.getElementById('navAvatar').src = navAvatarImg.src;
                    showResult(`å¯¼èˆªæ å¤´åƒ: ${navAvatarImg.src}`, 'info');
                }

                if (dropdownAvatarImg) {
                    document.getElementById('dropdownAvatar').src = dropdownAvatarImg.src;
                    showResult(`ä¸‹æ‹‰èœå•å¤´åƒ: ${dropdownAvatarImg.src}`, 'info');
                }

                if (profileAvatarImg) {
                    document.getElementById('profileAvatar').src = profileAvatarImg.src;
                    showResult(`ä¸ªäººèµ„æ–™å¤´åƒ: ${profileAvatarImg.src}`, 'info');
                }

                showResult('âœ… å½“å‰å¤´åƒåŠ è½½å®Œæˆ', 'success');
            } catch (error) {
                showResult(`âŒ åŠ è½½å¤´åƒå¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function simulateAvatarUpdate() {
            try {
                // æ¨¡æ‹Ÿå¤´åƒæ›´æ–°
                const testAvatarUrl = `https://ui-avatars.com/api/?name=Test&background=ff6b6b&color=fff&size=120&t=${Date.now()}`;
                
                if (window.userDropdownManager) {
                    const currentInfo = await window.userDropdownManager.getCurrentUserInfo();
                    if (currentInfo) {
                        const updatedInfo = {
                            ...currentInfo,
                            avatar: testAvatarUrl
                        };
                        window.userDropdownManager.updateUserInfo(updatedInfo);
                        showResult('âœ… æ¨¡æ‹Ÿå¤´åƒæ›´æ–°å®Œæˆ', 'success');
                        
                        // é‡æ–°åŠ è½½æ˜¾ç¤º
                        setTimeout(() => loadCurrentAvatars(), 500);
                    }
                } else {
                    showResult('âŒ userDropdownManager æœªæ‰¾åˆ°', 'error');
                }
            } catch (error) {
                showResult(`âŒ æ¨¡æ‹Ÿæ›´æ–°å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function checkUserInfo() {
            try {
                if (!window.supabaseClient) {
                    throw new Error('Supabaseå®¢æˆ·ç«¯æœªåˆå§‹åŒ–');
                }

                // æ£€æŸ¥è®¤è¯çŠ¶æ€
                const { data: { user }, error } = await window.supabaseClient.auth.getUser();
                if (error) throw error;

                if (user) {
                    showResult(`âœ… ç”¨æˆ·å·²ç™»å½•: ${user.email}`, 'success');
                    
                    // æ£€æŸ¥profilesè¡¨æ•°æ®
                    const { data: profiles, error: profileError } = await window.supabaseClient
                        .from('profiles')
                        .select('username, avatar_url')
                        .eq('id', user.id)
                        .single();

                    if (profileError) {
                        showResult(`âš ï¸ è·å–profileå¤±è´¥: ${profileError.message}`, 'error');
                    } else {
                        showResult(`ğŸ“‹ Profileæ•°æ®: username=${profiles.username || 'æœªè®¾ç½®'}, avatar_url=${profiles.avatar_url || 'æœªè®¾ç½®'}`, 'info');
                    }

                    // æ£€æŸ¥userDropdownManagerçŠ¶æ€
                    if (window.userDropdownManager) {
                        const userInfo = await window.userDropdownManager.getCurrentUserInfo();
                        showResult(`ğŸ‘¤ å½“å‰ç”¨æˆ·ä¿¡æ¯: ${JSON.stringify(userInfo)}`, 'info');
                    }
                } else {
                    showResult('âŒ ç”¨æˆ·æœªç™»å½•', 'error');
                }
            } catch (error) {
                showResult(`âŒ æ£€æŸ¥ç”¨æˆ·ä¿¡æ¯å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function refreshUserInfo() {
            try {
                if (window.userDropdownManager) {
                    const userInfo = await window.userDropdownManager.getCurrentUserInfo();
                    if (userInfo) {
                        window.userDropdownManager.updateUserInfo(userInfo);
                        showResult('âœ… ç”¨æˆ·ä¿¡æ¯åˆ·æ–°å®Œæˆ', 'success');
                        
                        // é‡æ–°åŠ è½½æ˜¾ç¤º
                        setTimeout(() => loadCurrentAvatars(), 500);
                    }
                } else {
                    showResult('âŒ userDropdownManager æœªæ‰¾åˆ°', 'error');
                }
            } catch (error) {
                showResult(`âŒ åˆ·æ–°å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            showResult('ğŸš€ å¤´åƒæ›´æ–°æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ', 'info');
            
            // å»¶è¿ŸåŠ è½½ï¼Œç¡®ä¿å…¶ä»–è„šæœ¬å·²åˆå§‹åŒ–
            setTimeout(() => {
                loadCurrentAvatars();
                checkUserInfo();
            }, 1000);
        });
    </script>
</body>
</html>
