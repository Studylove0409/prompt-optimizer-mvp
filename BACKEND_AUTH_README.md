# 后端用户认证和历史记录功能

## 新增功能概述

本次更新为智优词项目添加了完整的用户认证和历史记录功能，支持已登录用户的优化历史记录保存。

## 🚀 新增功能

### 1. 用户认证系统
- **JWT令牌验证**：支持Supabase JWT令牌验证
- **可选认证**：支持匿名用户使用优化功能
- **用户身份提取**：从JWT令牌中提取用户信息

### 2. 历史记录功能
- **已登录用户**：自动保存每次优化操作到数据库，使用用户ID标识
- **匿名用户**：自动保存每次优化操作到数据库，使用基于IP的会话ID标识
- **历史查询**：支持获取用户的优化历史记录（已登录用户和匿名用户都支持）
- **数据隔离**：每个用户/会话只能查看自己的历史记录

### 3. 新增API端点

#### `/api/optimize` (POST)
- **功能**：提示词优化（支持匿名和已登录用户）
- **认证**：可选（Bearer Token）
- **历史记录**：所有用户自动保存（已登录用户使用用户ID，匿名用户使用会话ID）

#### `/api/history` (GET)
- **功能**：获取用户历史记录（支持已登录用户和匿名用户）
- **认证**：可选（Bearer Token）
- **参数**：`session_id`（可选，用于匿名用户查询特定会话）
- **返回**：用户的优化历史列表

#### `/api/user/profile` (GET)
- **功能**：获取用户profile信息
- **认证**：必需（Bearer Token）
- **返回**：用户信息、profile、订阅状态

#### `/api/user/stats` (GET)
- **功能**：获取用户使用统计
- **认证**：必需（Bearer Token）
- **返回**：总优化次数、模式统计、最近使用情况

## 📊 数据库表结构

项目使用以下3个核心表：

### 1. profiles (用户信息扩展表)
```sql
CREATE TABLE public.profiles (
  id UUID PRIMARY KEY NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  username TEXT UNIQUE,
  avatar_url TEXT,
  updated_at TIMESTAMPTZ DEFAULT now() NOT NULL
);
```

### 2. optimization_history (提示词优化历史表)
```sql
CREATE TABLE public.optimization_history (
  id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  original_prompt TEXT NOT NULL,
  optimized_prompt TEXT NOT NULL,
  mode TEXT NOT NULL,
  created_at TIMESTAMPTZ DEFAULT now() NOT NULL
);
```

### 3. subscriptions (用户订阅状态表)
```sql
CREATE TABLE public.subscriptions (
  id UUID PRIMARY KEY NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  status public.subscription_status NOT NULL,
  plan_id TEXT,
  current_period_start TIMESTAMPTZ,
  current_period_end TIMESTAMPTZ,
  stripe_customer_id TEXT UNIQUE,
  stripe_subscription_id TEXT UNIQUE
);
```

## 🔧 配置要求

### 环境变量
在 `backend/.env` 文件中添加：

```env
# Supabase配置
SUPABASE_URL='your-supabase-url'
SUPABASE_ANON_KEY='your-supabase-anon-key'
SUPABASE_JWT_SECRET='your-supabase-jwt-secret'
```

### 依赖包
新增的Python依赖：

```txt
supabase
pyjwt
python-jose[cryptography]
```

## 🛡️ 安全配置

### Supabase RLS策略
需要在Supabase中配置行级安全策略，执行 `supabase_rls_policies.sql` 或 `supabase_minimal_rls.sql`：

```sql
-- 启用RLS
ALTER TABLE public.optimization_history ENABLE ROW LEVEL SECURITY;

-- 允许用户插入自己的历史记录
CREATE POLICY "Users can insert own optimization history" ON public.optimization_history
    FOR INSERT WITH CHECK (auth.uid() = user_id);

-- 允许用户查看自己的历史记录
CREATE POLICY "Users can view own optimization history" ON public.optimization_history
    FOR SELECT USING (auth.uid() = user_id);
```

## 📝 使用说明

### 1. 匿名用户使用
```javascript
// 不提供Authorization头
fetch('/api/optimize', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    original_prompt: "写一个Python函数",
    model: "deepseek-reasoner",
    mode: "general"
  })
});
```

### 2. 已登录用户使用
```javascript
// 提供Supabase JWT令牌
fetch('/api/optimize', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${supabaseAccessToken}`
  },
  body: JSON.stringify({
    original_prompt: "写一个Python函数",
    model: "deepseek-reasoner",
    mode: "general"
  })
});
```

### 3. 获取历史记录
```javascript
fetch('/api/history', {
  headers: {
    'Authorization': `Bearer ${supabaseAccessToken}`
  }
});
```

## 🔄 核心逻辑

### 历史记录保存逻辑
```python
# 仅已登录用户保存历史记录
if user and user.id:
    await self.supabase_service.save_optimization_history(
        user_id=str(user.id),
        original_prompt=request.original_prompt,
        optimized_prompt=optimized_prompt,
        mode=request.mode
    )
```

### 认证流程
1. 前端发送请求时可选择性包含 `Authorization: Bearer <token>`
2. 后端验证JWT令牌（如果提供）
3. 提取用户信息或标记为匿名用户
4. 执行优化功能
5. 如果是已登录用户，保存历史记录

## 🧪 测试

使用真实的Supabase用户进行测试：
1. 在前端注册/登录用户
2. 获取Supabase access token
3. 使用token调用后端API
4. 验证历史记录是否正确保存

## 📁 文件结构

```
backend/
├── app/
│   ├── auth.py              # 用户认证模块
│   ├── services/
│   │   ├── supabase_service.py  # Supabase数据库服务
│   │   └── prompt_service.py    # 优化服务（已更新）
│   └── routers/
│       ├── optimize.py      # 优化路由（已更新）
│       ├── history.py       # 历史记录路由
│       └── user.py          # 用户信息路由
├── supabase_rls_policies.sql   # RLS策略配置
└── supabase_minimal_rls.sql    # 最小RLS配置
```

## ✅ 功能验证

- [x] 匿名用户可以使用优化功能
- [x] 已登录用户可以使用优化功能
- [x] 已登录用户的历史记录自动保存
- [x] 用户可以查询自己的历史记录
- [x] JWT令牌验证正常工作
- [x] 数据库RLS策略保护用户数据安全
