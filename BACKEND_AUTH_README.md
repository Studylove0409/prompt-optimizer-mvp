# åç«¯ç”¨æˆ·è®¤è¯å’Œå†å²è®°å½•åŠŸèƒ½

## æ–°å¢åŠŸèƒ½æ¦‚è¿°

æœ¬æ¬¡æ›´æ–°ä¸ºæ™ºä¼˜è¯é¡¹ç›®æ·»åŠ äº†å®Œæ•´çš„ç”¨æˆ·è®¤è¯å’Œå†å²è®°å½•åŠŸèƒ½ï¼Œæ”¯æŒå·²ç™»å½•ç”¨æˆ·çš„ä¼˜åŒ–å†å²è®°å½•ä¿å­˜ã€‚

## ğŸš€ æ–°å¢åŠŸèƒ½

### 1. ç”¨æˆ·è®¤è¯ç³»ç»Ÿ
- **JWTä»¤ç‰ŒéªŒè¯**ï¼šæ”¯æŒSupabase JWTä»¤ç‰ŒéªŒè¯
- **å¯é€‰è®¤è¯**ï¼šæ”¯æŒåŒ¿åç”¨æˆ·ä½¿ç”¨ä¼˜åŒ–åŠŸèƒ½
- **ç”¨æˆ·èº«ä»½æå–**ï¼šä»JWTä»¤ç‰Œä¸­æå–ç”¨æˆ·ä¿¡æ¯

### 2. å†å²è®°å½•åŠŸèƒ½
- **å·²ç™»å½•ç”¨æˆ·**ï¼šè‡ªåŠ¨ä¿å­˜æ¯æ¬¡ä¼˜åŒ–æ“ä½œåˆ°æ•°æ®åº“ï¼Œä½¿ç”¨ç”¨æˆ·IDæ ‡è¯†
- **åŒ¿åç”¨æˆ·**ï¼šè‡ªåŠ¨ä¿å­˜æ¯æ¬¡ä¼˜åŒ–æ“ä½œåˆ°æ•°æ®åº“ï¼Œä½¿ç”¨åŸºäºIPçš„ä¼šè¯IDæ ‡è¯†
- **å†å²æŸ¥è¯¢**ï¼šæ”¯æŒè·å–ç”¨æˆ·çš„ä¼˜åŒ–å†å²è®°å½•ï¼ˆå·²ç™»å½•ç”¨æˆ·å’ŒåŒ¿åç”¨æˆ·éƒ½æ”¯æŒï¼‰
- **æ•°æ®éš”ç¦»**ï¼šæ¯ä¸ªç”¨æˆ·/ä¼šè¯åªèƒ½æŸ¥çœ‹è‡ªå·±çš„å†å²è®°å½•

### 3. æ–°å¢APIç«¯ç‚¹

#### `/api/optimize` (POST)
- **åŠŸèƒ½**ï¼šæç¤ºè¯ä¼˜åŒ–ï¼ˆæ”¯æŒåŒ¿åå’Œå·²ç™»å½•ç”¨æˆ·ï¼‰
- **è®¤è¯**ï¼šå¯é€‰ï¼ˆBearer Tokenï¼‰
- **å†å²è®°å½•**ï¼šæ‰€æœ‰ç”¨æˆ·è‡ªåŠ¨ä¿å­˜ï¼ˆå·²ç™»å½•ç”¨æˆ·ä½¿ç”¨ç”¨æˆ·IDï¼ŒåŒ¿åç”¨æˆ·ä½¿ç”¨ä¼šè¯IDï¼‰

#### `/api/history` (GET)
- **åŠŸèƒ½**ï¼šè·å–ç”¨æˆ·å†å²è®°å½•ï¼ˆæ”¯æŒå·²ç™»å½•ç”¨æˆ·å’ŒåŒ¿åç”¨æˆ·ï¼‰
- **è®¤è¯**ï¼šå¯é€‰ï¼ˆBearer Tokenï¼‰
- **å‚æ•°**ï¼š`session_id`ï¼ˆå¯é€‰ï¼Œç”¨äºåŒ¿åç”¨æˆ·æŸ¥è¯¢ç‰¹å®šä¼šè¯ï¼‰
- **è¿”å›**ï¼šç”¨æˆ·çš„ä¼˜åŒ–å†å²åˆ—è¡¨

#### `/api/user/profile` (GET)
- **åŠŸèƒ½**ï¼šè·å–ç”¨æˆ·profileä¿¡æ¯
- **è®¤è¯**ï¼šå¿…éœ€ï¼ˆBearer Tokenï¼‰
- **è¿”å›**ï¼šç”¨æˆ·ä¿¡æ¯ã€profileã€è®¢é˜…çŠ¶æ€

#### `/api/user/stats` (GET)
- **åŠŸèƒ½**ï¼šè·å–ç”¨æˆ·ä½¿ç”¨ç»Ÿè®¡
- **è®¤è¯**ï¼šå¿…éœ€ï¼ˆBearer Tokenï¼‰
- **è¿”å›**ï¼šæ€»ä¼˜åŒ–æ¬¡æ•°ã€æ¨¡å¼ç»Ÿè®¡ã€æœ€è¿‘ä½¿ç”¨æƒ…å†µ

## ğŸ“Š æ•°æ®åº“è¡¨ç»“æ„

é¡¹ç›®ä½¿ç”¨ä»¥ä¸‹3ä¸ªæ ¸å¿ƒè¡¨ï¼š

### 1. profiles (ç”¨æˆ·ä¿¡æ¯æ‰©å±•è¡¨)
```sql
CREATE TABLE public.profiles (
  id UUID PRIMARY KEY NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  username TEXT UNIQUE,
  avatar_url TEXT,
  updated_at TIMESTAMPTZ DEFAULT now() NOT NULL
);
```

### 2. optimization_history (æç¤ºè¯ä¼˜åŒ–å†å²è¡¨)
```sql
CREATE TABLE public.optimization_history (
  id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  original_prompt TEXT NOT NULL,
  optimized_prompt TEXT NOT NULL,
  mode TEXT NOT NULL,
  created_at TIMESTAMPTZ DEFAULT now() NOT NULL
);
```

### 3. subscriptions (ç”¨æˆ·è®¢é˜…çŠ¶æ€è¡¨)
```sql
CREATE TABLE public.subscriptions (
  id UUID PRIMARY KEY NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  status public.subscription_status NOT NULL,
  plan_id TEXT,
  current_period_start TIMESTAMPTZ,
  current_period_end TIMESTAMPTZ,
  stripe_customer_id TEXT UNIQUE,
  stripe_subscription_id TEXT UNIQUE
);
```

## ğŸ”§ é…ç½®è¦æ±‚

### ç¯å¢ƒå˜é‡
åœ¨ `backend/.env` æ–‡ä»¶ä¸­æ·»åŠ ï¼š

```env
# Supabaseé…ç½®
SUPABASE_URL='your-supabase-url'
SUPABASE_ANON_KEY='your-supabase-anon-key'
SUPABASE_JWT_SECRET='your-supabase-jwt-secret'
```

### ä¾èµ–åŒ…
æ–°å¢çš„Pythonä¾èµ–ï¼š

```txt
supabase
pyjwt
python-jose[cryptography]
```

## ğŸ›¡ï¸ å®‰å…¨é…ç½®

### Supabase RLSç­–ç•¥
éœ€è¦åœ¨Supabaseä¸­é…ç½®è¡Œçº§å®‰å…¨ç­–ç•¥ï¼Œæ‰§è¡Œ `supabase_rls_policies.sql` æˆ– `supabase_minimal_rls.sql`ï¼š

```sql
-- å¯ç”¨RLS
ALTER TABLE public.optimization_history ENABLE ROW LEVEL SECURITY;

-- å…è®¸ç”¨æˆ·æ’å…¥è‡ªå·±çš„å†å²è®°å½•
CREATE POLICY "Users can insert own optimization history" ON public.optimization_history
    FOR INSERT WITH CHECK (auth.uid() = user_id);

-- å…è®¸ç”¨æˆ·æŸ¥çœ‹è‡ªå·±çš„å†å²è®°å½•
CREATE POLICY "Users can view own optimization history" ON public.optimization_history
    FOR SELECT USING (auth.uid() = user_id);
```

## ğŸ“ ä½¿ç”¨è¯´æ˜

### 1. åŒ¿åç”¨æˆ·ä½¿ç”¨
```javascript
// ä¸æä¾›Authorizationå¤´
fetch('/api/optimize', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    original_prompt: "å†™ä¸€ä¸ªPythonå‡½æ•°",
    model: "deepseek-reasoner",
    mode: "general"
  })
});
```

### 2. å·²ç™»å½•ç”¨æˆ·ä½¿ç”¨
```javascript
// æä¾›Supabase JWTä»¤ç‰Œ
fetch('/api/optimize', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${supabaseAccessToken}`
  },
  body: JSON.stringify({
    original_prompt: "å†™ä¸€ä¸ªPythonå‡½æ•°",
    model: "deepseek-reasoner",
    mode: "general"
  })
});
```

### 3. è·å–å†å²è®°å½•
```javascript
fetch('/api/history', {
  headers: {
    'Authorization': `Bearer ${supabaseAccessToken}`
  }
});
```

## ğŸ”„ æ ¸å¿ƒé€»è¾‘

### å†å²è®°å½•ä¿å­˜é€»è¾‘
```python
# ä»…å·²ç™»å½•ç”¨æˆ·ä¿å­˜å†å²è®°å½•
if user and user.id:
    await self.supabase_service.save_optimization_history(
        user_id=str(user.id),
        original_prompt=request.original_prompt,
        optimized_prompt=optimized_prompt,
        mode=request.mode
    )
```

### è®¤è¯æµç¨‹
1. å‰ç«¯å‘é€è¯·æ±‚æ—¶å¯é€‰æ‹©æ€§åŒ…å« `Authorization: Bearer <token>`
2. åç«¯éªŒè¯JWTä»¤ç‰Œï¼ˆå¦‚æœæä¾›ï¼‰
3. æå–ç”¨æˆ·ä¿¡æ¯æˆ–æ ‡è®°ä¸ºåŒ¿åç”¨æˆ·
4. æ‰§è¡Œä¼˜åŒ–åŠŸèƒ½
5. å¦‚æœæ˜¯å·²ç™»å½•ç”¨æˆ·ï¼Œä¿å­˜å†å²è®°å½•

## ğŸ§ª æµ‹è¯•

ä½¿ç”¨çœŸå®çš„Supabaseç”¨æˆ·è¿›è¡Œæµ‹è¯•ï¼š
1. åœ¨å‰ç«¯æ³¨å†Œ/ç™»å½•ç”¨æˆ·
2. è·å–Supabase access token
3. ä½¿ç”¨tokenè°ƒç”¨åç«¯API
4. éªŒè¯å†å²è®°å½•æ˜¯å¦æ­£ç¡®ä¿å­˜

## ğŸ“ æ–‡ä»¶ç»“æ„

```
backend/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ auth.py              # ç”¨æˆ·è®¤è¯æ¨¡å—
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ supabase_service.py  # Supabaseæ•°æ®åº“æœåŠ¡
â”‚   â”‚   â””â”€â”€ prompt_service.py    # ä¼˜åŒ–æœåŠ¡ï¼ˆå·²æ›´æ–°ï¼‰
â”‚   â””â”€â”€ routers/
â”‚       â”œâ”€â”€ optimize.py      # ä¼˜åŒ–è·¯ç”±ï¼ˆå·²æ›´æ–°ï¼‰
â”‚       â”œâ”€â”€ history.py       # å†å²è®°å½•è·¯ç”±
â”‚       â””â”€â”€ user.py          # ç”¨æˆ·ä¿¡æ¯è·¯ç”±
â”œâ”€â”€ supabase_rls_policies.sql   # RLSç­–ç•¥é…ç½®
â””â”€â”€ supabase_minimal_rls.sql    # æœ€å°RLSé…ç½®
```

## âœ… åŠŸèƒ½éªŒè¯

- [x] åŒ¿åç”¨æˆ·å¯ä»¥ä½¿ç”¨ä¼˜åŒ–åŠŸèƒ½
- [x] å·²ç™»å½•ç”¨æˆ·å¯ä»¥ä½¿ç”¨ä¼˜åŒ–åŠŸèƒ½
- [x] å·²ç™»å½•ç”¨æˆ·çš„å†å²è®°å½•è‡ªåŠ¨ä¿å­˜
- [x] ç”¨æˆ·å¯ä»¥æŸ¥è¯¢è‡ªå·±çš„å†å²è®°å½•
- [x] JWTä»¤ç‰ŒéªŒè¯æ­£å¸¸å·¥ä½œ
- [x] æ•°æ®åº“RLSç­–ç•¥ä¿æŠ¤ç”¨æˆ·æ•°æ®å®‰å…¨
